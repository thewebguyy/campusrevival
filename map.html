<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CRM Map - UK Universities</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* ===== General Styles ===== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #000;
      color: #fff;
      min-height: 100vh;
    }
    a { text-decoration: none; color: inherit; }

    /* ===== Header Placeholder ===== */
    #header-placeholder { width: 100%; }

    /* ===== Hero Section ===== */
    .hero {
      background-color: #000000;
      text-align: center;
      padding: 60px 20px;
    }
    .hero h1 {
      font-family: "Baskerville Old Face";
      font-size: 2rem;
      margin-bottom: 20px;
      color: #ffffff;
    }
    .stats-bar {
      background-color: #000000;
      padding: 15px 20px;
      border-radius: 8px;
      display: flex;
      justify-content: center;
      gap: 50px;
      margin-bottom: 20px;
      font-size: 1.2rem;
    }
    .stats-bar strong { color: #ffffff; }
    .hero p { font-size: 1rem; color: #ccc; }

    /* ===== Container & Map ===== */
    .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
    #map { height: 75vh; width: 100%; border-radius: 12px; }

    /* ===== Side Panel ===== */
    #side-panel {
      position: fixed;
      top: 0;
      right: -450px;
      width: 450px;
      height: 100%;
      background: #111;
      color: #fff;
      box-shadow: -6px 0 24px rgba(0,0,0,0.25);
      transition: right 0.3s ease;
      overflow-y: auto;
      padding: 30px;
      border-left: 1px solid rgba(255,255,255,0.1);
      z-index: 10000;
    }
    #side-panel.active { right: 0; }
    #side-panel header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      border-bottom: 2px solid #333;
      padding-bottom: 15px;
    }

    #side-panel h2 {
      font-size: 1.5rem;
      color: #fff;
      margin: 0;
    }

    .close-panel-btn { 
      background: none; 
      border: none; 
      font-size: 28px; 
      cursor: pointer; 
      color: #ccc; 
      transition: color 0.3s;
    }

    .close-panel-btn:hover {
      color: #fff;
    }

    .school-info {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .school-info h3 {
      color: #6a00ff;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }

    .school-info p {
      margin: 10px 0;
      line-height: 1.6;
      color: #ddd;
    }

    .school-info .label {
      color: #888;
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    .adopter-count {
      display: inline-block;
      background: linear-gradient(135deg, #6a00ff, #012169);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      margin: 10px 0;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }

    .btn {
      padding: 14px 20px;
      font-size: 1rem;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      text-decoration: none;
      display: block;
    }

    .btn-primary {
      background: linear-gradient(135deg, #012169, #6a00ff);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(106, 0, 255, 0.4);
    }

    .btn-prayer {
      background: #012169;
      color: white;
    }

    .btn-prayer:hover {
      background: #013599;
    }

    .btn-revival {
      background: #6a00ff;
      color: white;
    }

    .btn-revival:hover {
      background: #5500cc;
    }

    .btn-secondary {
      background: #333;
      color: white;
    }

    .btn-secondary:hover {
      background: #444;
    }

    .adopters-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #333;
    }

    .adopters-section h4 {
      color: #6a00ff;
      margin-bottom: 15px;
    }

    .adopter-item {
      padding: 12px;
      margin-bottom: 10px;
      background: #1a1a1a;
      border-radius: 6px;
      border-left: 3px solid #6a00ff;
    }

    .adopter-item strong {
      color: #fff;
    }

    .adopter-item small {
      color: #aaa;
    }

    .loading {
      text-align: center;
      color: #999;
      padding: 20px;
    }

    .error-message {
      background: #ff6b6b;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin: 20px;
      text-align: center;
    }

    /* ===== Responsive ===== */
    @media (max-width: 900px) {
      #side-panel { width: 100%; right: -100%; }
      #side-panel.active { right: 0; }
      #map { height: 60vh; }
      .stats-bar { flex-direction: column; gap: 8px; }
    }
  </style>
</head>
<body>

  <!-- ===== HEADER PLACEHOLDER ===== -->
  <div id="header-placeholder"></div>

  <!-- ===== HERO SECTION ===== -->
  <section class="hero">
    <h1>CAMPUS REVIVAL MOVEMENT MAP</h1>
    <h2>UK Universities for Adoption</h2>
    <div class="stats-bar">
      <div>Total Universities: <strong id="totalSchools">0</strong></div>
      <div>Total Adopters: <strong id="adoptedCount">0</strong></div>
    </div>
    <p>Click on any university marker to view details and adopt for prayer or revival.</p>
  </section>

  <!-- ===== MAP CONTAINER ===== -->
  <div class="container">
    <div id="map"></div>
  </div>

  <!-- ===== SIDE PANEL ===== -->
  <aside id="side-panel" aria-hidden="true">
    <header>
      <h2 id="panel-title">University Details</h2>
      <button class="close-panel-btn" onclick="closePanel()" aria-label="Close panel">√ó</button>
    </header>
    <div id="panel-content">
      <p class="loading">Select a university on the map...</p>
    </div>
  </aside>

  <!-- ===== SCRIPTS ===== -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="utils/api.js"></script>
  <script>
    // ===== FETCH HEADER =====
    fetch('header.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('header-placeholder').innerHTML = html;
        const hamburger = document.getElementById('hamburger');
        const navMenu = document.getElementById('nav-menu');
        if(hamburger && navMenu){
          hamburger.addEventListener('click', () => {
            navMenu.classList.toggle('active');
            hamburger.classList.toggle('open');
          });
        }
      })
      .catch(err => console.error('Error loading header:', err));

    // ===== MAP & DATA LOGIC =====
    let allSchools = [];
    let map;
    let schoolMarkers = {};

    // Custom marker icons
    const createMarkerIcon = (color) => {
      return L.divIcon({
        className: 'custom-marker',
        html: `<div style="background-color: ${color}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>`,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });
    };

    // Load schools from API
    async function loadSchools() {
      try {
        const schools = await getAllSchools();
        allSchools = schools;
        
        initMap();
        updateStats();
      } catch (error) {
        console.error('Failed to load schools:', error);
        document.querySelector('.container').innerHTML = `
          <div class="error-message">
            <h3>‚ö†Ô∏è Failed to Load Universities</h3>
            <p>${error.message}</p>
            <p>Please make sure the backend is running.</p>
            <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 15px; display: inline-block;">Retry</button>
          </div>
        `;
      }
    }

    function initMap(){
      // Initialize map centered on UK
      map = L.map('map').setView([54.5, -3], 6);
      
      // Add tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        maxZoom: 18, 
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      // Add marker for EACH university
      allSchools.forEach(school => {
        const markerColor = (school.adoptionCount && school.adoptionCount > 0) ? '#6a00ff' : '#00ff88';
        const icon = createMarkerIcon(markerColor);
        
        const marker = L.marker([school.lat, school.lng], { icon: icon }).addTo(map);
        
        // Store reference
        schoolMarkers[school._id] = marker;
        
        // Click handler - open side panel with school details
        marker.on('click', () => {
          openSchoolPanel(school);
        });
        
        // Tooltip on hover
        const adopterText = school.adoptionCount === 0 ? 'Not yet adopted' :
                           school.adoptionCount === 1 ? '1 adopter' :
                           `${school.adoptionCount} adopters`;
        
        marker.bindTooltip(`<strong>${school.name}</strong><br>${adopterText}`, {
          direction: 'top',
          offset: [0, -10]
        });
      });

      updateStats();
    }

    // Open side panel with school details
    function openSchoolPanel(school) {
      const adopterCount = school.adoptionCount || 0;
      const adopterText = adopterCount === 0 ? 'No adopters yet' : 
                          adopterCount === 1 ? '1 person has adopted this university' :
                          `${adopterCount} people have adopted this university`;
      
      let content = `
        <div class="school-info">
          <h3>${school.name}</h3>
          
          <div class="label">Location</div>
          <p>${school.address}</p>
          
          ${school.description ? `
            <div class="label" style="margin-top: 15px;">About</div>
            <p>${school.description}</p>
          ` : ''}
          
          <div class="adopter-count">${adopterText}</div>
        </div>

        <div class="action-buttons">
          <a href="read-more.html?schoolId=${school._id}" class="btn btn-primary">
            üìñ View Full Details
          </a>
          <a href="adopt-prayer.html?schoolId=${school._id}" class="btn btn-prayer">
            üôè Adopt for Prayer
          </a>
          <a href="adopt-revival.html?schoolId=${school._id}" class="btn btn-revival">
            ‚ö° Adopt for Revival
          </a>
      `;
      
      // Add adopters section if there are any
      if (adopterCount > 0) {
        content += `<button class="btn btn-secondary" onclick="loadAdopters('${school._id}', '${school.name.replace(/'/g, "\\'")}')">
          üë• View All Adopters (${adopterCount})
        </button>`;
      }
      
      content += `</div>`;
      
      document.getElementById('panel-title').textContent = school.name;
      document.getElementById('panel-content').innerHTML = content;
      
      const panel = document.getElementById('side-panel');
      panel.classList.add('active');
      panel.setAttribute('aria-hidden', 'false');
    }

    // Load adopters for a school
    async function loadAdopters(schoolId, schoolName) {
      const panelContent = document.getElementById('panel-content');
      panelContent.innerHTML = '<p class="loading">Loading adopters...</p>';
      
      try {
        const data = await getSchoolAdopters(schoolId);
        
        let html = `
          <div class="school-info">
            <h3>${schoolName}</h3>
            <div class="adopter-count">Total Adopters: ${data.totalAdopters}</div>
          </div>

          <div class="adopters-section">
            <h4>Adopters List</h4>
        `;
        
        if (data.adopters.length === 0) {
          html += '<p style="color: #888;">No adopters yet. Be the first!</p>';
        } else {
          data.adopters.forEach((adopter, index) => {
            const date = new Date(adopter.adoptedAt).toLocaleDateString();
            const type = adopter.adoptionType || 'prayer';
            html += `
              <div class="adopter-item">
                <strong>${index + 1}. ${adopter.userId.name}</strong><br>
                <small>Type: ${type.charAt(0).toUpperCase() + type.slice(1)}</small><br>
                <small>Adopted: ${date}</small>
              </div>
            `;
          });
        }
        
        html += `
          </div>
          <button class="btn btn-secondary" onclick="closePanel()" style="margin-top: 20px;">
            ‚Üê Back to Map
          </button>
        `;
        
        panelContent.innerHTML = html;
        
      } catch (error) {
        console.error('Error loading adopters:', error);
        panelContent.innerHTML = `
          <div style="padding: 20px; color: #ff6b6b;">
            <p>Failed to load adopters: ${error.message}</p>
            <button class="btn btn-secondary" onclick="closePanel()" style="margin-top: 20px;">
              ‚Üê Back to Map
            </button>
          </div>
        `;
      }
    }

    function closePanel(){
      const panel = document.getElementById('side-panel');
      panel.classList.remove('active');
      panel.setAttribute('aria-hidden', 'true');
    }

    function updateStats(){
      const totalAdopters = allSchools.reduce((sum, school) => sum + (school.adoptionCount || 0), 0);
      
      document.getElementById('totalSchools').textContent = allSchools.length;
      document.getElementById('adoptedCount').textContent = totalAdopters;
    }

    // Close panel on escape key
    document.addEventListener('keydown', e => { 
      if(e.key === 'Escape') closePanel(); 
    });

    // Close panel on outside click
    document.addEventListener('click', e => {
      const panel = document.getElementById('side-panel');
      if(panel.classList.contains('active') && 
         !panel.contains(e.target) && 
         !e.target.closest('.leaflet-popup') &&
         !e.target.closest('.leaflet-marker-icon')) {
        closePanel();
      }
    });

    // Initialize on page load
    window.addEventListener('load', loadSchools);
  </script>
</body>
</html>